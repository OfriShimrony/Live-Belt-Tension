# CoreXY Belt Tension Tuner - Klipper Macros
# ============================================
# 
# Usage from Mainsail/Fluidd console:
#   BELT_TUNE BELT=A    - Measure Belt A (3 plucks with averaging)
#   BELT_TUNE BELT=B    - Measure Belt B
#   BELT_COMPARE        - Measure and compare both belts
#
# Features:
# - Automatic pluck detection
# - Sub-Hz accuracy
# - Outlier rejection
# - Multi-measurement averaging

[gcode_shell_command belt_tune_cmd]
command: python3 ~/Live-Belt-Tension/src/belt_tuner.py
timeout: 120.0
verbose: True

[gcode_macro BELT_TUNE]
description: Measure belt frequency with manual pluck detection
gcode:
    {% set belt = params.BELT|default('A')|upper %}
    
    {% if belt not in ['A', 'B'] %}
        RESPOND MSG="Error: BELT must be A or B"
        RESPOND MSG="Usage: BELT_TUNE BELT=A"
        {action_raise_error("Invalid belt parameter")}
    {% endif %}
    
    RESPOND MSG="Starting Belt {belt} measurement..."
    RESPOND MSG="Position: Current location"
    RESPOND MSG=""
    
    # Run the belt tuner
    RUN_SHELL_COMMAND CMD=belt_tune_cmd PARAMS="BELT={belt}"

[gcode_macro BELT_COMPARE]
description: Measure and compare both belts
gcode:
    RESPOND MSG="Starting belt comparison..."
    RESPOND MSG="This will measure both belts with 3 plucks each"
    RESPOND MSG=""
    
    # Run the comparison
    RUN_SHELL_COMMAND CMD=belt_tune_cmd PARAMS="COMPARE"

# Quick measurement (single pluck for testing)
[gcode_macro BELT_TUNE_QUICK]
description: Quick single measurement (for testing)
gcode:
    {% set belt = params.BELT|default('A')|upper %}
    {% set duration = params.DURATION|default(3)|float %}
    
    RESPOND MSG="Belt {belt} - Quick measurement"
    RESPOND MSG="Pluck the belt in:"
    RESPOND MSG="  3..."
    G4 P800
    RESPOND MSG="  2..."
    G4 P800
    RESPOND MSG="  1..."
    G4 P800
    RESPOND MSG="  >>> PLUCK NOW! <<<"
    
    # Start measurement
    ACCELEROMETER_MEASURE CHIP=adxl345
    
    # Wait for pluck and decay
    G4 P{duration * 1000}
    
    # Stop and analyze
    ACCELEROMETER_MEASURE CHIP=adxl345 NAME=belt_{belt}_quick
    
    RESPOND MSG="Measurement complete"
    RESPOND MSG="Run analysis manually: python3 ~/Live-Belt-Tension/src/belt_analyzer_v3.py /tmp/adxl345-belt_{belt}_quick.csv"
