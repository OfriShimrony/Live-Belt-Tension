# Integrated Shake and Measure Macros
# These macros shake the belt, trigger measurement, and run analysis

[gcode_macro MEASURE_BELT_A]
description: Shake Belt A and measure frequency automatically
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        { action_respond_info("Please home the printer first!") }
    {% else %}
        RESPOND MSG="=== Measuring Belt A ==="
        
        # Start accelerometer measurement
        RESPOND MSG="Starting measurement..."
        ACCELEROMETER_MEASURE CHIP=adxl345
        
        # Wait a moment for measurement to stabilize
        G4 P500
        
        # Shake the belt (diagonal X+Y movement)
        RESPOND MSG="Shaking belt..."
        SAVE_GCODE_STATE NAME=measure_a
        G91
        G0 X25 Y25 F12000
        G4 P50
        G0 X-25 Y-25 F12000
        G4 P50
        G0 X25 Y25 F12000
        G4 P50
        G0 X-25 Y-25 F12000
        RESTORE_GCODE_STATE NAME=measure_a
        
        # Let vibrations settle and be captured
        G4 P1500
        
        # Stop measurement
        RESPOND MSG="Stopping measurement..."
        ACCELEROMETER_MEASURE CHIP=adxl345 NAME=belt_a_auto
        
        # Analysis happens in web UI or manually run diagnostic
        RESPOND MSG="=== Belt A measurement complete ==="
        RESPOND MSG="Run: python3 quick_belt_diagnostic.py"
    {% endif %}

[gcode_macro MEASURE_BELT_B]
description: Shake Belt B and measure frequency automatically
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        { action_respond_info("Please home the printer first!") }
    {% else %}
        RESPOND MSG="=== Measuring Belt B ==="
        
        # Start accelerometer measurement
        RESPOND MSG="Starting measurement..."
        ACCELEROMETER_MEASURE CHIP=adxl345
        
        # Wait a moment
        G4 P500
        
        # Shake the belt (diagonal X-Y movement)
        RESPOND MSG="Shaking belt..."
        SAVE_GCODE_STATE NAME=measure_b
        G91
        G0 X25 Y-25 F12000
        G4 P50
        G0 X-25 Y25 F12000
        G4 P50
        G0 X25 Y-25 F12000
        G4 P50
        G0 X-25 Y25 F12000
        RESTORE_GCODE_STATE NAME=measure_b
        
        # Let vibrations settle
        G4 P1500
        
        # Stop measurement
        RESPOND MSG="Stopping measurement..."
        ACCELEROMETER_MEASURE CHIP=adxl345 NAME=belt_b_auto
        
        RESPOND MSG="=== Belt B measurement complete ==="
        RESPOND MSG="Run: python3 quick_belt_diagnostic.py"
    {% endif %}

[gcode_macro MEASURE_BOTH_BELTS]
description: Measure both belts in sequence
gcode:
    RESPOND MSG="======================================="
    RESPOND MSG="Measuring Both Belts"
    RESPOND MSG="======================================="
    
    MEASURE_BELT_A
    G4 P2000  ; Wait 2 seconds between measurements
    
    MEASURE_BELT_B
    
    RESPOND MSG="======================================="
    RESPOND MSG="Both belts measured!"
    RESPOND MSG="Check results in web UI or run diagnostics"
    RESPOND MSG="======================================="
