# CoreXY Belt Tension Tuner - Simple Macros (No Extension Required)
# ==================================================================
# 
# These macros capture data, then you analyze via SSH.
#
# Usage:
#   1. Run BELT_TUNE_CAPTURE BELT=A from console
#   2. Pluck when prompted (3 times)
#   3. SSH to printer: python3 ~/belt_tuner.py BELT=A
#   4. Results display
#
# For automatic analysis, install gcode_shell_command extension:
#   https://github.com/dw-0/kiauh

[gcode_macro BELT_TUNE_CAPTURE]
description: Capture belt pluck data (analyze via SSH afterward)
gcode:
    {% set belt = params.BELT|default('A')|upper %}
    {% set count = params.COUNT|default(3)|int %}
    
    {% if belt not in ['A', 'B'] %}
        RESPOND MSG="Error: BELT must be A or B"
        {action_raise_error("Invalid belt parameter")}
    {% endif %}
    
    RESPOND MSG="=== Belt {belt} Data Capture ==="
    RESPOND MSG="Will capture {count} plucks"
    RESPOND MSG=""
    
    {% for i in range(count) %}
        RESPOND MSG="Pluck {i+1}/{count} - Get ready..."
        G4 P1000
        
        RESPOND MSG="  3..."
        G4 P800
        RESPOND MSG="  2..."
        G4 P800
        RESPOND MSG="  1..."
        G4 P800
        RESPOND MSG="  >>> PLUCK NOW! <<<"
        
        ACCELEROMETER_MEASURE CHIP=adxl345
        G4 P3000
        ACCELEROMETER_MEASURE CHIP=adxl345 NAME=belt_{belt}_{i+1}
        
        RESPOND MSG="  Captured"
        
        {% if i < count - 1 %}
            RESPOND MSG=""
            G4 P1000
        {% endif %}
    {% endfor %}
    
    RESPOND MSG=""
    RESPOND MSG="Data capture complete!"
    RESPOND MSG="To analyze, SSH to printer and run:"
    RESPOND MSG="  python3 ~/belt_tuner.py BELT={belt}"

[gcode_macro BELT_COMPARE_CAPTURE]
description: Capture data for both belts (analyze via SSH afterward)
gcode:
    RESPOND MSG="=== Belt Comparison Data Capture ==="
    RESPOND MSG=""
    
    RESPOND MSG="First: Belt A"
    BELT_TUNE_CAPTURE BELT=A COUNT=3
    
    RESPOND MSG=""
    G4 P2000
    
    RESPOND MSG="Now: Belt B"
    BELT_TUNE_CAPTURE BELT=B COUNT=3
    
    RESPOND MSG=""
    RESPOND MSG="Both belts captured!"
    RESPOND MSG="To compare, SSH to printer and run:"
    RESPOND MSG="  python3 ~/belt_tuner.py COMPARE"

# Quick single pluck for testing
[gcode_macro BELT_QUICK_TEST]
description: Quick single pluck test
gcode:
    {% set belt = params.BELT|default('A')|upper %}
    
    RESPOND MSG="Belt {belt} - Quick Test"
    RESPOND MSG="Pluck in: 3..."
    G4 P800
    RESPOND MSG="  2..."
    G4 P800
    RESPOND MSG="  1..."
    G4 P800
    RESPOND MSG="  >>> PLUCK! <<<"
    
    ACCELEROMETER_MEASURE CHIP=adxl345
    G4 P3000
    ACCELEROMETER_MEASURE CHIP=adxl345 NAME=belt_{belt}_quick
    
    RESPOND MSG="Captured: /tmp/adxl345-belt_{belt}_quick.csv"
    RESPOND MSG="To analyze:"
    RESPOND MSG="  python3 ~/Live-Belt-Tension/src/belt_analyzer_v3.py /tmp/adxl345-belt_{belt}_quick.csv"
